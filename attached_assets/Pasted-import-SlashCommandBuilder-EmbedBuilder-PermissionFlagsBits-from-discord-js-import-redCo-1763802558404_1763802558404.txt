import { SlashCommandBuilder, EmbedBuilder, PermissionFlagsBits } from "discord.js";
import { redColor, greenColor } from '../../config.js'

export default {
    data: new SlashCommandBuilder()
        .setName('timeout')
        .setDescription('Gestion du/des timeout du serveur.')
        .addSubcommand(sb =>
            sb.setName('add').setDescription('Ajouter un timeout Ã  un utilisateur.')
            .addUserOption(opt =>
                opt.setName('user').setDescription('L\'utilisateur Ã  mettre en timeout.').setRequired(true)
            )
            .addStringOption(opt =>
                opt.setName('duration').setDescription('La durÃ©e du timeout').setRequired(true)
            )
            .addStringOption(opt =>
                opt.setName('reason').setDescription('La raison du timeout.').setRequired(false)
            )
        )
        .addSubcommand(sb =>
            sb.setName('remove').setDescription('Retirer le timeout d\'un utilisateur.')
            .addUserOption(opt =>
                opt.setName('user').setDescription('L\'utilisateur Ã  retirer du timeout.').setRequired(true)
            )
        )
        .addSubcommand(sb =>
            sb.setName('list').setDescription('Afficher la liste des utilisateurs en timeout.')
        )
        .setDefaultMemberPermissions(PermissionFlagsBits.MuteMembers),

    async execute(interaction) {
        const sub = interaction.options.getSubcommand();

        if (sub === 'add') {
            const user = interaction.options.getUser('user');
            const duration = interaction.options.getString('duration');
            const reason = interaction.options.getString('reason') || 'Aucune raison fournie';
            const member = await interaction.guild.members.fetch(user.id).catch(() => null);

            if (!member) {
                const embed = new EmbedBuilder()
                    .setTitle('`âŒ`ã€ƒUtilisateur introuvable')
                    .setDescription(`> *L'utilisateur ${user} (\`${user?.id}\` | \`${user?.tag}\`) n'a pas Ã©tÃ© trouvÃ© sur ce serveur.*`)
                    .setColor(redColor)
                    .setFooter({ text: interaction.user.tag, iconURL: interaction.user.displayAvatarURL() });
                return interaction.reply({ embeds: [embed], ephemeral: true });
            }

            const ms = parseDuration(duration);
            if (!ms) {
                const embed = new EmbedBuilder()
                    .setTitle('`âŒ`ã€ƒInvalid Duration')
                    .setDescription('> *La durÃ©e fournie est invalide. Veuillez utiliser un format valide (ex: 10m, 2h, 1d, 7w...).*')
                    .setColor(redColor)
                    .setFooter({ text: interaction.user.tag, iconURL: interaction.user.displayAvatarURL() });
                return interaction.reply({ embeds: [embed], ephemeral: true });
            }
            if (!member.moderatable) {
                const embed = new EmbedBuilder()
                    .setTitle('`âŒ`ã€ƒCannot Timeout User')
                    .setDescription(`> *Je ne peux pas mettre en timeout l'utilisateur ${user} (\`${user.id}\` | \`${user.tag}\`).*`)
                    .setColor(redColor)
                    .setFooter({ text: interaction.user.tag, iconURL: interaction.user.displayAvatarURL() });
                return interaction.reply({ embeds: [embed], ephemeral: true });
            }
            if (member.roles.highest.position >= interaction.member.roles.highest.position) {
                const embed = new EmbedBuilder()
                    .setTitle('`âŒ`ã€ƒMissing Permissions')
                    .setDescription(`> *Vous ne pouvez pas mettre en timeout l'utilisateur ${user} (\`${user.id}\` | \`${user.tag}\`) car son rÃ´le est supÃ©rieur ou Ã©gal au vÃ´tre.*`)
                    .setColor(redColor)
                    .setFooter({ text: interaction.user.tag, iconURL: interaction.user.displayAvatarURL() });
                return interaction.reply({ embeds: [embed], ephemeral: true });
            }
            try {
                await member.timeout(ms, reason);
                const embed = new EmbedBuilder()
                    .setTitle('`âœ…`ã€ƒTimeout Added')
                    .setDescription(`> *L'utilisateur ${user} (\`${user.id}\` | \`${user.tag}\`) a Ã©tÃ© mis en timeout pour \`${duration}\` !*\n> **Raison :** ${reason}`)
                    .setColor(greenColor)
                    .setFooter({ text: interaction.user.tag, iconURL: interaction.user.displayAvatarURL() });
                const embedmp = new EmbedBuilder()
                    .setTitle('`â±ï¸`ã€ƒYou Have Been Timed Out')
                    .setDescription(`> *Vous avez Ã©tÃ© mis en timeout sur le serveur ${interaction.guild.name} pendant \`${duration}\`.*\n\`\`\`ansi\n[1;31m${reason}[0m\n\`\`\``)
                    .setColor('Orange')
                    .setFooter({ text: interaction.guild.name, iconURL: interaction.guild.iconURL() });
                await user.send({ embeds: [embedmp]  }).catch(() => {});
                return interaction.reply({ embeds: [embed], ephemeral: false });
            } catch (error) {
                const embed = new EmbedBuilder()
                    .setTitle('`âŒ`ã€ƒErreur')
                    .setDescription('> *Une erreur est survenue lors de la tentative de timeout de l\'utilisateur.*\n\`\`\`ansi\n[1;31m${error}[0m\n\`\`\`')
                    .setColor(redColor)
                    .setFooter({ text: interaction.user.tag, iconURL: interaction.user.displayAvatarURL() });
                return interaction.reply({ embeds: [embed], ephemeral: true });
            }
        } else if (sub === 'remove') {
            const user = interaction.options.getUser('user');
            const member = await interaction.guild.members.fetch(user.id).catch(() => null);

            if (!member) {
                const embed = new EmbedBuilder()
                    .setTitle('`âŒ`ã€ƒUtilisateur introuvable')
                    .setDescription(`> *L'utilisateur ${user} n'a pas Ã©tÃ© trouvÃ© sur ce serveur.*`)
                    .setColor(redColor)
                    .setFooter({ text: interaction.user.tag, iconURL: interaction.user.displayAvatarURL() });
                return interaction.reply({ embeds: [embed], ephemeral: true });
            }

            try {
                await member.timeout(null, `Timeout retirÃ© par ${interaction.user.tag}`);
                const embed = new EmbedBuilder()
                    .setTitle('`âœ…`ã€ƒTimeout RetirÃ©')
                    .setDescription(`> *Le timeout de ${user} a Ã©tÃ© retirÃ©.*`)
                    .setColor(greenColor)
                    .setFooter({ text: interaction.user.tag, iconURL: interaction.user.displayAvatarURL() });
                return interaction.reply({ embeds: [embed], ephemeral: false });
            } catch (err) {
                const embed = new EmbedBuilder()
                    .setTitle('`âŒ`ã€ƒErreur')
                    .setDescription('> *Impossible de retirer le timeout de cet utilisateur.*\n\`\`\`ansi\n[1;31m${err}[0m\n\`\`\`')
                    .setColor(redColor)
                    .setFooter({ text: interaction.user.tag, iconURL: interaction.user.displayAvatarURL() });
                return interaction.reply({ embeds: [embed], ephemeral: true });
            }
        } else if (sub === 'list') {
            // Fetch members and filter those currently timed out
            await interaction.guild.members.fetch();
            const timedOut = interaction.guild.members.cache.filter(m => m.communicationDisabledUntil && m.communicationDisabledUntil > Date.now());
            if (timedOut.size === 0) {
                const embed = new EmbedBuilder()
                    .setTitle('`â„¹ï¸`ã€ƒTimeouts')
                    .setDescription('> *Aucun utilisateur n\'est actuellement en timeout.*')
                    .setColor('Blue')
                    .setFooter({ text: interaction.user.tag, iconURL: interaction.user.displayAvatarURL() });
                return interaction.reply({ embeds: [embed], ephemeral: true });
            }

            const description = timedOut.map(m => `> ${m.user} (\`${m.user.id}\`) - fin: <t:${Math.floor(m.communicationDisabledUntil / 1000)}:R>`).slice(0, 50).join('\n');
            const embed = new EmbedBuilder()
                .setTitle('`ðŸ“‹`ã€ƒListe des timeouts')
                .setDescription(description)
                .setColor('Blue')
                .setFooter({ text: interaction.guild.name, iconURL: interaction.guild.iconURL() });
            return interaction.reply({ embeds: [embed], ephemeral: true });
        } else {
            return interaction.reply({ content: 'Sous-commande inconnue.', ephemeral: true });
        }
    }
}

function parseDuration(input) {
    if (!input || typeof input !== 'string') return null;
    const match = input.trim().toLowerCase().match(/^(\d+)\s*(s|m|h|d|w)?$/);
    if (!match) return null;
    const val = Number(match[1]);
    const unit = match[2] || 'm';
    const multipliers = { s: 1000, m: 60 * 1000, h: 60 * 60 * 1000, d: 24 * 60 * 60 * 1000, w: 7 * 24 * 60 * 60 * 1000 };
    return val * (multipliers[unit] || multipliers.m);
}